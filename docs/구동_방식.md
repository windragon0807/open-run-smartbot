# 챗봇 구동 방식

## 전체 아키텍처

```
[사용자] → [Next.js 프론트엔드] → [Next.js API Route (프록시)] → [FastAPI 봇 서버] → [OpenAI API]
                                                                        ↕
                                                                  [ChromaDB (벡터 DB)]
                                                                        ↕
                                                                  [knowledge/ 폴더 (문서)]
```

### 구성 요소

| 구성 요소 | 기술 스택 | 역할 |
|-----------|----------|------|
| 프론트엔드 UI | Next.js + ChatBot 컴포넌트 | 사용자 채팅 인터페이스 |
| API 프록시 | Next.js API Route (`/api/chat`) | 봇 서버로의 요청 중계 |
| 봇 서버 | FastAPI (Python) | RAG 파이프라인 실행, API 제공 |
| 벡터 DB | ChromaDB | 문서 임베딩 저장 및 유사도 검색 |
| LLM | OpenAI GPT-4o-mini | 답변 생성 |
| 임베딩 | OpenAI text-embedding-3-small | 문서/질문 벡터화 |

---

## 요청 흐름

### 1. 사용자 질문 전송

사용자가 채팅 UI에서 질문을 입력하면 프론트엔드가 Next.js API Route로 요청을 보냅니다.

```
POST /api/chat
Body: { "question": "오픈런이 뭐야?" }
```

### 2. API 프록시 (Next.js → FastAPI)

`frontend/src/app/api/chat/route.ts`가 봇 서버의 RAG 엔드포인트로 요청을 중계합니다.

```
POST {BOT_SERVER_URL}/rag/query
Body: { "question": "오픈런이 뭐야?" }
```

- `BOT_SERVER_URL`은 프론트엔드의 환경변수로 설정
- 프록시를 사용하는 이유: CORS 우회, API 키 보호, 서버 주소 은닉

### 3. RAG 파이프라인 (봇 서버)

봇 서버에서 RAG(Retrieval-Augmented Generation) 방식으로 답변을 생성합니다.

**단계:**

1. **문서 검색 (Retrieval)**: 질문을 임베딩하여 ChromaDB에서 가장 관련 있는 문서 청크 3개를 검색
2. **프롬프트 구성 (Augmentation)**: 검색된 문서를 시스템 프롬프트에 삽입
3. **답변 생성 (Generation)**: GPT-4o-mini가 문서 기반으로 답변 생성

### 4. 응답 반환

```json
{
  "answer": "오픈런은 함께 달리는 러닝 소셜 서비스입니다...",
  "sources": [
    { "content": "문서 내용...", "source": "01_서비스_개요.md" }
  ]
}
```

---

## knowledge/ 폴더 관리

### 문서 자동 동기화

봇 서버는 `knowledge/` 폴더를 실시간으로 감시합니다 (`watchfiles` 라이브러리 사용).

| 이벤트 | 동작 |
|--------|------|
| 서버 시작 | 전체 문서를 ChromaDB에 동기화 (초기화 후 재저장) |
| 파일 추가/수정 | 해당 파일의 기존 벡터 삭제 → 새로 청크 분할 → 벡터 DB에 저장 |
| 파일 삭제 | 해당 파일의 벡터 데이터를 DB에서 제거 |

### 문서 처리 과정

1. `.txt`, `.md` 파일만 지원
2. `RecursiveCharacterTextSplitter`로 청크 분할 (500자 단위, 50자 오버랩)
3. `text-embedding-3-small` 모델로 임베딩 생성
4. ChromaDB에 벡터 + 메타데이터(파일명) 저장

### 현재 knowledge 문서 목록

| 파일명 | 내용 |
|--------|------|
| 01_서비스_개요.md | 오픈런 서비스 소개 |
| 02_회원가입_및_로그인.md | 회원가입/로그인 안내 |
| 03_홈_화면.md | 홈 화면 기능 설명 |
| 04_벙_만들기.md | 벙 생성 가이드 |
| 05_벙_상세_및_관리.md | 벙 상세/관리 기능 |
| 06_탐색_및_검색.md | 탐색/검색 기능 |
| 07_도전과제.md | 도전과제 시스템 |
| 08_아바타.md | 아바타 기능 |
| 09_프로필.md | 프로필 기능 |
| 10_용어_사전.md | 서비스 용어 정리 |

---

## API 엔드포인트

### 핵심 엔드포인트

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | `/rag/query` | RAG 기반 질문 답변 (프론트엔드에서 사용) |
| POST | `/chat` | 일반 GPT 채팅 (RAG 미사용) |

### 문서 관리 엔드포인트

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/documents` | 문서 목록 조회 |
| GET | `/documents/{filename}` | 특정 문서 내용 조회 |
| PUT | `/documents/{filename}` | 문서 내용 수정 (watcher가 자동 반영) |
| POST | `/documents/sync` | 전체 문서 수동 동기화 |
| DELETE | `/documents/reset` | 벡터 DB 초기화 |

### 기타

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/` | 서버 상태 확인 |
| GET | `/models` | 사용 가능한 GPT 모델 목록 |
| GET | `/manage` | 관리 UI 페이지 |
| GET | `/docs` | Swagger UI (FastAPI 자동 생성) |

---

## CI/CD: 프론트엔드 변경 → 문서 자동 업데이트 → 봇 서버 배포

프론트엔드 코드가 변경되면, 챗봇이 참조하는 knowledge 문서도 자동으로 업데이트되어야 합니다.
이를 위해 두 개의 GitHub Actions 워크플로우가 순차적으로 동작합니다.

### 전체 흐름

```
① 프론트엔드 코드 변경 → main 브랜치에 push
        ↓
② doc-sync.yml 실행 (frontend/src/** 변경 감지)
        ↓
③ generate_docs.py가 git diff를 OpenAI에 보내서 분석
   "이 코드 변경이 서비스 사양에 영향을 주는가?"
        ↓
④ 영향 있음 → knowledge/ 문서 자동 수정 → PR 생성
   영향 없음 → 아무 일도 일어나지 않음
        ↓
⑤ 팀원이 PR 리뷰 후 머지
        ↓
⑥ bot/** 변경 감지 → bot-deploy.yml 실행
        ↓
⑦ Docker 이미지 빌드 (수정된 knowledge/ 포함)
        ↓
⑧ GCP Cloud Run에 자동 배포
        ↓
⑨ 봇 서버 재시작 → watcher.py가 knowledge/ 전체를 ChromaDB에 동기화
        ↓
⑩ 챗봇이 최신 사양으로 답변
```

### 워크플로우 1: 문서 자동 업데이트 (`doc-sync.yml`)

- **트리거**: `main` 브랜치에 `frontend/src/**` 경로 변경이 push될 때
- **동작**:
  1. `generate_docs.py --mode ci --apply` 실행
  2. 스크립트가 `git diff`로 프론트엔드 변경사항 추출
  3. 현재 knowledge/ 문서와 함께 OpenAI API에 전달
  4. AI가 "사양에 영향을 주는 변경인지" 판단
  5. 영향이 있으면 문서를 수정하고 PR 자동 생성
- **결과**: `docs/auto-update` 브랜치에 PR이 생성됨
- **주의**: 사람이 리뷰 후 머지해야 반영됨 (자동 머지 아님)

### 워크플로우 2: 봇 서버 배포 (`bot-deploy.yml`)

- **트리거**: `main` 브랜치에 `bot/**` 경로 변경이 push될 때 (위 PR 머지 포함)
- **동작**:
  1. Docker 이미지 빌드 (`bot/Dockerfile` 사용)
  2. GCP Artifact Registry에 이미지 push
  3. GCP Cloud Run에 배포
- **배포 환경**:
  - 리전: `asia-northeast3` (서울)
  - 메모리: 1Gi, CPU: 1
  - 인스턴스: 0~3개 (요청 없으면 0으로 스케일다운)
  - 포트: 8000

### generate_docs.py 스크립트

AI 문서 자동 업데이트의 핵심 스크립트입니다.

```bash
# CI에서 사용 (최근 커밋 기준, 변경사항 자동 적용)
python scripts/generate_docs.py --mode ci --apply

# 수동 분석 (적용 없이 결과만 확인)
python scripts/generate_docs.py --mode api --from-ref HEAD~5 --to-ref HEAD
```

**처리 과정**:
1. `git diff`로 `frontend/src/` 변경사항 추출 (CSS, 테스트 파일 제외)
2. knowledge/ 폴더의 모든 문서를 읽어옴
3. diff + 문서를 OpenAI API에 전달하여 분석
4. 사양 변경이 있으면 수정된 문서 내용을 JSON으로 반환
5. `--apply` 옵션이 있으면 파일에 직접 저장

### 필요한 GitHub Secrets

| Secret 이름 | 용도 |
|-------------|------|
| `OPENAI_API_KEY` | generate_docs.py의 AI 분석 + Cloud Run 환경변수 |
| `GCP_DEPLOYMENT_SA_KEY` | GCP 서비스 계정 키 (Cloud Run 배포용) |
| `GITHUB_TOKEN` | PR 자동 생성 (기본 제공) |

---

## 실행 방법

### 로컬 실행

```bash
cd bot
source .venv/bin/activate
python main.py
```

서버가 `http://localhost:8000`에서 실행됩니다.

### Docker 실행

```bash
cd bot
docker-compose up --build
```

- `knowledge/` 폴더가 볼륨 마운트되어 로컬 파일 변경이 실시간 반영됩니다.
- 포트: `8000:8000`

### 프론트엔드 연동

프론트엔드의 `.env`에 봇 서버 주소를 설정합니다:

```env
BOT_SERVER_URL=http://localhost:8000
```

---

## 기술 상세

### 사용 라이브러리

| 라이브러리 | 버전 | 용도 |
|-----------|------|------|
| FastAPI | ≥0.115.0 | 웹 서버 프레임워크 |
| uvicorn | ≥0.34.0 | ASGI 서버 |
| openai | ≥1.0.0 | OpenAI API 클라이언트 |
| langchain | ≥0.3.0 | RAG 파이프라인 |
| langchain-openai | ≥0.3.0 | LangChain OpenAI 연동 |
| langchain-chroma | ≥0.2.0 | LangChain ChromaDB 연동 |
| chromadb | ≥0.6.0 | 벡터 데이터베이스 |
| watchfiles | - | 파일 변경 감시 (watcher.py에서 사용) |
| python-dotenv | ≥1.0.0 | 환경변수 관리 |

### 디렉토리 구조

```
bot/
├── main.py              # FastAPI 서버 진입점
├── schemas.py           # Pydantic 요청/응답 모델
├── requirements.txt     # Python 의존성
├── Dockerfile           # Docker 이미지 정의
├── docker-compose.yml   # Docker Compose 설정
├── .env                 # 환경변수 (OPENAI_API_KEY)
├── rag/                 # RAG 파이프라인 모듈
│   ├── chain.py         # LangChain RAG 체인 구성
│   ├── document_loader.py  # 문서 로드 및 청크 분할
│   ├── vector_store.py  # ChromaDB 벡터 저장소 관리
│   └── watcher.py       # knowledge/ 폴더 실시간 감시
├── knowledge/           # RAG 참조 문서 (마크다운)
├── chroma_db/           # ChromaDB 데이터 (자동 생성, gitignore)
├── static/              # 관리 UI 정적 파일
│   └── manage.html      # 관리 페이지
├── scripts/             # 유틸리티 스크립트
│   └── generate_docs.py
└── docs/                # 프로젝트 문서
    ├── 서버_실행_가이드.md
    └── 구동_방식.md      # (이 문서)
```
