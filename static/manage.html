<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenRun Bot - ë¬¸ì„œ ê´€ë¦¬</title>
  <!-- marked.js: ë§ˆí¬ë‹¤ìš´ íŒŒì„œ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- highlight.js: ì½”ë“œ êµ¬ë¬¸ ê°•ì¡° -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* í—¤ë” */
    header {
      background: #1e293b;
      border-bottom: 1px solid #334155;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    header h1 {
      font-size: 18px;
      font-weight: 600;
      color: #f1f5f9;
    }

    header .status {
      font-size: 13px;
      color: #94a3b8;
    }

    header .status.saved { color: #4ade80; }
    header .status.saving { color: #facc15; }
    header .status.error { color: #f87171; }

    /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: 280px;
      background: #1e293b;
      border-right: 1px solid #334155;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #334155;
      font-size: 14px;
      font-weight: 600;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .doc-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .doc-item {
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #cbd5e1;
      transition: background 0.15s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .doc-item:hover { background: #334155; }
    .doc-item.active { background: #3b82f6; color: #fff; }

    .doc-item .size {
      font-size: 11px;
      color: #64748b;
    }

    .doc-item.active .size { color: #bfdbfe; }

    /* ì—ë””í„° ì˜ì—­ */
    .editor-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-toolbar {
      padding: 10px 20px;
      background: #1e293b;
      border-bottom: 1px solid #334155;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .editor-toolbar .filename {
      font-size: 15px;
      font-weight: 600;
      color: #f1f5f9;
      flex: 1;
    }

    .btn {
      padding: 7px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s, opacity 0.15s;
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-primary {
      background: #3b82f6;
      color: #fff;
    }

    .btn-primary:hover:not(:disabled) { background: #2563eb; }

    .btn-secondary {
      background: #334155;
      color: #e2e8f0;
    }

    .btn-secondary:hover:not(:disabled) { background: #475569; }

    .btn-tab {
      padding: 6px 14px;
      background: transparent;
      color: #94a3b8;
      border: 1px solid transparent;
    }

    .btn-tab.active {
      color: #f1f5f9;
      border-color: #475569;
      background: #334155;
    }

    /* ì—ë””í„° / ë¯¸ë¦¬ë³´ê¸° */
    .editor-content {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .editor-content textarea {
      width: 100%;
      height: 100%;
      background: #0f172a;
      color: #e2e8f0;
      border: none;
      padding: 20px;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.7;
      resize: none;
      outline: none;
      tab-size: 2;
    }

    .preview {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      padding: 20px 40px;
      display: none;
    }

    .preview.visible { display: block; }
    .editor-content textarea.hidden { display: none; }

    /* ë§ˆí¬ë‹¤ìš´ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ (marked.js ì¶œë ¥ìš©) */
    .preview { font-size: 15px; line-height: 1.8; color: #cbd5e1; }
    .preview h1 { font-size: 28px; margin: 32px 0 16px; color: #f1f5f9; border-bottom: 1px solid #334155; padding-bottom: 10px; font-weight: 700; }
    .preview h2 { font-size: 22px; margin: 28px 0 12px; color: #f1f5f9; border-bottom: 1px solid #334155; padding-bottom: 8px; font-weight: 600; }
    .preview h3 { font-size: 18px; margin: 24px 0 8px; color: #e2e8f0; font-weight: 600; }
    .preview h4 { font-size: 16px; margin: 20px 0 6px; color: #e2e8f0; font-weight: 600; }
    .preview p { margin: 10px 0; line-height: 1.8; }
    .preview ul, .preview ol { margin: 10px 0; padding-left: 28px; }
    .preview ul { list-style-type: disc; }
    .preview ol { list-style-type: decimal; }
    .preview li { margin: 5px 0; line-height: 1.7; }
    .preview li > ul, .preview li > ol { margin: 4px 0; }
    .preview code {
      background: #1e293b;
      padding: 2px 7px;
      border-radius: 4px;
      font-size: 13px;
      color: #f472b6;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    }
    .preview pre {
      background: #1e293b;
      padding: 18px;
      border-radius: 8px;
      margin: 16px 0;
      overflow-x: auto;
      border: 1px solid #334155;
    }
    .preview pre code {
      background: none;
      padding: 0;
      color: #e2e8f0;
      font-size: 13px;
      line-height: 1.6;
    }
    .preview blockquote {
      border-left: 4px solid #3b82f6;
      padding: 8px 16px;
      margin: 16px 0;
      color: #94a3b8;
      background: #1e293b;
      border-radius: 0 6px 6px 0;
    }
    .preview blockquote p { margin: 4px 0; }
    .preview strong { color: #f1f5f9; font-weight: 600; }
    .preview em { color: #a5b4fc; font-style: italic; }
    .preview a { color: #60a5fa; text-decoration: underline; }
    .preview a:hover { color: #93bbfd; }
    .preview hr { border: none; border-top: 1px solid #334155; margin: 24px 0; }
    .preview table { border-collapse: collapse; margin: 16px 0; width: 100%; }
    .preview th, .preview td { border: 1px solid #334155; padding: 10px 14px; text-align: left; }
    .preview th { background: #1e293b; color: #f1f5f9; font-weight: 600; }
    .preview tr:nth-child(even) { background: rgba(30, 41, 59, 0.4); }
    .preview img { max-width: 100%; border-radius: 8px; margin: 12px 0; }
    .preview h1:first-child, .preview h2:first-child { margin-top: 0; }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #475569;
      font-size: 16px;
    }

    /* ë¡œë”© */
    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #94a3b8;
      font-size: 14px;
      padding: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #334155;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      color: #fff;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s, transform 0.3s;
      z-index: 100;
    }

    .toast.visible { opacity: 1; transform: translateY(0); }
    .toast.success { background: #16a34a; }
    .toast.error { background: #dc2626; }

    /* === ì±—ë´‡ === */

    .chat-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: #3b82f6;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
      transition: transform 0.15s, background 0.15s;
      z-index: 200;
    }

    .chat-fab:hover { background: #2563eb; transform: scale(1.05); }
    .chat-fab:active { transform: scale(0.95); }
    .chat-fab svg { width: 24px; height: 24px; fill: #fff; }

    .chat-panel {
      position: fixed;
      bottom: 88px;
      right: 24px;
      width: 380px;
      height: 520px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 200;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .chat-panel.open { display: flex; }

    .chat-header {
      padding: 14px 16px;
      background: #1e293b;
      border-bottom: 1px solid #334155;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-header-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #3b82f6;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-header-icon svg { width: 18px; height: 18px; fill: #fff; }

    .chat-header-info h3 {
      font-size: 14px;
      font-weight: 600;
      color: #f1f5f9;
    }

    .chat-header-info p {
      font-size: 11px;
      color: #94a3b8;
    }

    .chat-close {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    .chat-close:hover { background: rgba(255,255,255,0.1); }
    .chat-close svg { width: 20px; height: 20px; }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px 14px;
    }

    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

    .chat-msg {
      margin-bottom: 12px;
      display: flex;
    }

    .chat-msg.user { justify-content: flex-end; }
    .chat-msg.bot { justify-content: flex-start; }

    .chat-bubble {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.6;
      word-break: break-word;
    }

    /* ì±—ë´‡ ë²„ë¸” ë‚´ ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
    .chat-bubble h1, .chat-bubble h2, .chat-bubble h3, .chat-bubble h4 {
      font-weight: 600;
      margin: 6px 0 2px;
      line-height: 1.4;
    }
    .chat-bubble h1 { font-size: 16px; }
    .chat-bubble h2 { font-size: 15px; }
    .chat-bubble h3 { font-size: 14px; }
    .chat-bubble h4 { font-size: 13px; }
    .chat-bubble h1:first-child, .chat-bubble h2:first-child,
    .chat-bubble h3:first-child, .chat-bubble h4:first-child { margin-top: 0; }
    .chat-bubble p { margin: 4px 0; }
    .chat-bubble p:first-child { margin-top: 0; }
    .chat-bubble p:last-child { margin-bottom: 0; }
    .chat-bubble ul, .chat-bubble ol { margin: 4px 0; padding-left: 20px; }
    .chat-bubble ul { list-style-type: disc; }
    .chat-bubble ol { list-style-type: decimal; }
    .chat-bubble li { margin: 1px 0; }
    .chat-bubble strong { color: #f1f5f9; font-weight: 600; }
    .chat-bubble em { font-style: italic; }
    .chat-bubble code {
      background: rgba(0,0,0,0.2);
      padding: 1px 5px;
      border-radius: 3px;
      font-size: 12px;
    }
    .chat-bubble pre {
      background: rgba(0,0,0,0.25);
      padding: 8px 10px;
      border-radius: 6px;
      margin: 4px 0;
      overflow-x: auto;
    }
    .chat-bubble pre code { background: none; padding: 0; }
    .chat-bubble blockquote {
      border-left: 3px solid #60a5fa;
      padding: 2px 8px;
      margin: 4px 0;
      opacity: 0.85;
    }

    .chat-msg.user .chat-bubble {
      background: #3b82f6;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .chat-msg.bot .chat-bubble {
      background: #334155;
      color: #e2e8f0;
      border-bottom-left-radius: 4px;
    }

    /* ë¬¸ì„œ ìœ„ì¹˜ ì¹´ë“œ */
    .loc-card {
      margin-top: 8px;
      padding: 10px 12px;
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 8px;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }

    .loc-card:hover {
      border-color: #3b82f6;
      background: #1e3a5f;
    }

    .loc-card-filename {
      font-size: 12px;
      font-weight: 600;
      color: #60a5fa;
      margin-bottom: 2px;
    }

    .loc-card-section {
      font-size: 11px;
      color: #94a3b8;
      margin-bottom: 4px;
    }

    .loc-card-snippet {
      font-size: 12px;
      color: #cbd5e1;
      font-style: italic;
    }

    .loc-card-open {
      font-size: 11px;
      color: #3b82f6;
      margin-top: 4px;
    }

    /* ë¡œë”© ì  */
    .chat-dots {
      display: flex;
      gap: 4px;
      padding: 4px 0;
    }

    .chat-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #94a3b8;
      animation: chatDotPulse 1s infinite;
    }

    .chat-dots span:nth-child(2) { animation-delay: 0.2s; }
    .chat-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes chatDotPulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    .chat-input-area {
      padding: 12px 14px;
      border-top: 1px solid #334155;
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .chat-input-area input {
      flex: 1;
      height: 40px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 20px;
      padding: 0 16px;
      font-size: 13px;
      color: #e2e8f0;
      outline: none;
      transition: border-color 0.15s;
    }

    .chat-input-area input:focus { border-color: #3b82f6; }
    .chat-input-area input::placeholder { color: #64748b; }
    .chat-input-area input:disabled { opacity: 0.5; }

    .chat-send {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #3b82f6;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.15s;
    }

    .chat-send:hover:not(:disabled) { background: #2563eb; }
    .chat-send:disabled { background: #334155; cursor: not-allowed; }
    .chat-send svg { width: 18px; height: 18px; fill: #fff; }

    /* === Diff ë¯¸ë¦¬ë³´ê¸° === */

    .diff-container {
      margin-top: 8px;
      max-height: 280px;
      overflow-y: auto;
      border: 1px solid #475569;
      border-radius: 6px;
      background: #0f172a;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 11px;
      line-height: 1.5;
    }

    .diff-container::-webkit-scrollbar { width: 4px; }
    .diff-container::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

    .diff-header {
      padding: 6px 10px;
      background: #1e293b;
      border-bottom: 1px solid #475569;
      font-size: 11px;
      font-weight: 600;
      color: #94a3b8;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .diff-line {
      padding: 1px 10px;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .diff-line-removed {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
    }

    .diff-line-added {
      background: rgba(34, 197, 94, 0.15);
      color: #86efac;
    }

    .diff-line-unchanged {
      color: #64748b;
    }

    .diff-line-separator {
      padding: 2px 10px;
      color: #475569;
      font-style: italic;
      background: #1e293b;
    }

    .diff-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .diff-actions button {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, opacity 0.15s;
    }

    .diff-actions button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .diff-btn-apply {
      background: #22c55e;
      color: #fff;
    }

    .diff-btn-apply:hover:not(:disabled) { background: #16a34a; }

    .diff-btn-cancel {
      background: #475569;
      color: #e2e8f0;
    }

    .diff-btn-cancel:hover:not(:disabled) { background: #64748b; }

    .edit-summary {
      margin-top: 6px;
      font-size: 12px;
      color: #94a3b8;
      line-height: 1.5;
    }

    /* === ì—ë””í„° ë¦¬ë·° ëª¨ë“œ === */

    .review-view {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      padding: 0;
      display: none;
      background: #0f172a;
    }

    .review-view.visible { display: block; }

    .review-toolbar {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: #1e293b;
      border-bottom: 1px solid #334155;
    }

    .review-toolbar-info {
      font-size: 13px;
      color: #94a3b8;
    }

    .review-toolbar-info strong {
      color: #f1f5f9;
    }

    .review-toolbar-actions {
      display: flex;
      gap: 8px;
    }

    .review-toolbar-actions .btn {
      padding: 5px 14px;
      font-size: 12px;
    }

    .btn-success {
      background: #22c55e;
      color: #fff;
    }

    .btn-success:hover:not(:disabled) { background: #16a34a; }

    .btn-danger {
      background: #ef4444;
      color: #fff;
    }

    .btn-danger:hover:not(:disabled) { background: #dc2626; }

    /* Hunk */
    .review-hunk {
      border: 1px solid #334155;
      border-radius: 8px;
      margin: 16px 20px;
      overflow: hidden;
    }

    .review-hunk.accepted {
      border-color: #22c55e;
      opacity: 0.6;
    }

    .review-hunk.rejected {
      border-color: #ef4444;
      opacity: 0.6;
    }

    .hunk-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 14px;
      background: #1e293b;
      border-bottom: 1px solid #334155;
    }

    .hunk-label {
      font-size: 12px;
      color: #94a3b8;
      font-weight: 600;
    }

    .hunk-actions {
      display: flex;
      gap: 6px;
    }

    .hunk-btn {
      padding: 4px 12px;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, opacity 0.15s;
    }

    .hunk-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .hunk-btn-accept {
      background: #22c55e;
      color: #fff;
    }

    .hunk-btn-accept:hover:not(:disabled) { background: #16a34a; }

    .hunk-btn-reject {
      background: #475569;
      color: #e2e8f0;
    }

    .hunk-btn-reject:hover:not(:disabled) { background: #64748b; }

    .hunk-status {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 4px;
    }

    .hunk-status.accepted {
      color: #4ade80;
      background: rgba(34, 197, 94, 0.1);
    }

    .hunk-status.rejected {
      color: #f87171;
      background: rgba(239, 68, 68, 0.1);
    }

    .hunk-lines {
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .hunk-line {
      padding: 1px 14px 1px 10px;
      white-space: pre-wrap;
      word-break: break-all;
      display: flex;
    }

    .hunk-line-num {
      display: inline-block;
      width: 36px;
      text-align: right;
      color: #475569;
      margin-right: 12px;
      flex-shrink: 0;
      user-select: none;
    }

    .hunk-line-text {
      flex: 1;
      min-width: 0;
    }

    .hunk-line.removed {
      background: rgba(239, 68, 68, 0.12);
      color: #fca5a5;
    }

    .hunk-line.added {
      background: rgba(34, 197, 94, 0.12);
      color: #86efac;
    }

    .hunk-line.context {
      color: #64748b;
    }

    .hunk-line.removed .hunk-line-num { color: #f87171; }
    .hunk-line.added .hunk-line-num { color: #4ade80; }

    .review-hunk-separator {
      text-align: center;
      padding: 4px;
      color: #475569;
      font-size: 11px;
      background: #0f172a;
    }

    /* === ë™ê¸°í™” ìƒíƒœ ëŒ€ì‹œë³´ë“œ === */

    .sync-dashboard {
      background: #1e293b;
      border-bottom: 1px solid #334155;
      overflow: hidden;
      transition: max-height 0.3s ease;
      max-height: 0;
    }

    .sync-dashboard.open {
      max-height: 600px;
    }

    .sync-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 13px;
      cursor: pointer;
      padding: 4px 10px;
      border-radius: 6px;
      transition: background 0.15s, color 0.15s;
    }

    .sync-toggle:hover {
      background: #334155;
      color: #e2e8f0;
    }

    .sync-toggle .indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .sync-toggle .indicator.ready { background: #4ade80; }
    .sync-toggle .indicator.syncing { background: #facc15; animation: pulse 1s infinite; }
    .sync-toggle .indicator.error { background: #f87171; }
    .sync-toggle .indicator.unknown { background: #64748b; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .sync-toggle .chevron {
      transition: transform 0.2s;
      width: 14px;
      height: 14px;
    }

    .sync-toggle.expanded .chevron {
      transform: rotate(180deg);
    }

    .sync-dashboard-inner {
      padding: 16px 24px 20px;
    }

    /* ìƒíƒœ ì¹´ë“œ ê·¸ë¦¬ë“œ */
    .sync-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .sync-card {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 14px 16px;
    }

    .sync-card-label {
      font-size: 11px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .sync-card-value {
      font-size: 22px;
      font-weight: 700;
      color: #f1f5f9;
      line-height: 1;
    }

    .sync-card-value.success { color: #4ade80; }
    .sync-card-value.warning { color: #facc15; }
    .sync-card-value.error { color: #f87171; }
    .sync-card-value.muted { color: #64748b; }

    .sync-card-sub {
      font-size: 11px;
      color: #64748b;
      margin-top: 4px;
    }

    /* íŒŒì¼ ë™ê¸°í™” ìƒíƒœ í…Œì´ë¸” */
    .sync-section-title {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sync-file-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .sync-file-table th {
      text-align: left;
      padding: 8px 12px;
      background: #0f172a;
      color: #64748b;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #334155;
    }

    .sync-file-table td {
      padding: 8px 12px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
      color: #cbd5e1;
    }

    .sync-file-table tr:hover td {
      background: rgba(51, 65, 85, 0.3);
    }

    .sync-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .sync-badge.ok {
      background: rgba(74, 222, 128, 0.1);
      color: #4ade80;
    }

    .sync-badge.err {
      background: rgba(248, 113, 113, 0.1);
      color: #f87171;
    }

    .sync-badge.pending {
      background: rgba(250, 204, 21, 0.1);
      color: #facc15;
    }

    /* ì´ë²¤íŠ¸ ë¡œê·¸ */
    .sync-events {
      margin-top: 16px;
    }

    .sync-event-list {
      max-height: 160px;
      overflow-y: auto;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
    }

    .sync-event-list::-webkit-scrollbar { width: 4px; }
    .sync-event-list::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

    .sync-event-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 12px;
      font-size: 12px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.3);
    }

    .sync-event-item:last-child { border-bottom: none; }

    .sync-event-time {
      color: #475569;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      flex-shrink: 0;
      width: 72px;
    }

    .sync-event-icon {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .sync-event-icon.ok { background: #4ade80; }
    .sync-event-icon.err { background: #f87171; }

    .sync-event-text {
      color: #94a3b8;
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .sync-event-file {
      color: #60a5fa;
      font-weight: 500;
    }

    /* ìˆ˜ë™ ë™ê¸°í™” ë²„íŠ¼ */
    .sync-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-sync {
      padding: 5px 14px;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, opacity 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-sync:hover:not(:disabled) { background: #2563eb; }
    .btn-sync:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-sync .sync-icon {
      width: 14px;
      height: 14px;
      transition: transform 0.3s;
    }

    .btn-sync.syncing .sync-icon {
      animation: spin 0.8s linear infinite;
    }

    .sync-auto-refresh {
      font-size: 11px;
      color: #475569;
    }

    /* DB ê±´ê°• ìƒíƒœ */
    .db-health {
      margin-top: 16px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      overflow: hidden;
    }

    .db-health-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: #1e293b;
      border-bottom: 1px solid #334155;
    }

    .db-health-title {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .db-health-overall {
      font-size: 12px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 10px;
    }

    .db-health-overall.healthy {
      background: rgba(74, 222, 128, 0.1);
      color: #4ade80;
    }

    .db-health-overall.degraded {
      background: rgba(250, 204, 21, 0.1);
      color: #facc15;
    }

    .db-health-overall.unhealthy {
      background: rgba(248, 113, 113, 0.1);
      color: #f87171;
    }

    .db-health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1px;
      background: #334155;
    }

    .db-health-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 14px;
      background: #0f172a;
      font-size: 12px;
    }

    .db-health-item-label {
      color: #64748b;
    }

    .db-health-item-value {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .db-health-item-value.ok { color: #4ade80; }
    .db-health-item-value.warn { color: #facc15; }
    .db-health-item-value.fail { color: #f87171; }
    .db-health-item-value.muted { color: #64748b; }

    .db-health-error {
      padding: 8px 14px;
      background: rgba(248, 113, 113, 0.08);
      border-top: 1px solid rgba(248, 113, 113, 0.2);
      font-size: 12px;
      color: #f87171;
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }

    .db-health-error-icon {
      flex-shrink: 0;
      margin-top: 1px;
    }

    /* ì²­í¬ ë¶ˆì¼ì¹˜ ê²½ê³  ë°°ë„ˆ */
    .sync-warning-banner {
      display: none;
      padding: 10px 16px;
      background: rgba(250, 204, 21, 0.08);
      border: 1px solid rgba(250, 204, 21, 0.2);
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #facc15;
      align-items: center;
      gap: 8px;
    }

    .sync-warning-banner.visible {
      display: flex;
    }

    .sync-warning-banner svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }
  </style>
</head>
<body>

<header>
  <h1>OpenRun Bot - ë¬¸ì„œ ê´€ë¦¬</h1>
  <div style="display:flex; align-items:center; gap:12px;">
    <button class="sync-toggle" id="syncToggle" onclick="toggleSyncDashboard()">
      <span class="indicator unknown" id="syncIndicator"></span>
      <span id="syncToggleLabel">ë™ê¸°í™” ìƒíƒœ</span>
      <svg class="chevron" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <span id="statusText" class="status"></span>
  </div>
</header>

<!-- ë™ê¸°í™” ìƒíƒœ ëŒ€ì‹œë³´ë“œ -->
<div class="sync-dashboard" id="syncDashboard">
  <div class="sync-dashboard-inner">
    <!-- ê²½ê³  ë°°ë„ˆ -->
    <div class="sync-warning-banner" id="syncWarningBanner">
      <svg viewBox="0 0 24 24" fill="none"><path d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span id="syncWarningText"></span>
    </div>

    <!-- ìƒíƒœ ì¹´ë“œ -->
    <div class="sync-cards">
      <div class="sync-card">
        <div class="sync-card-label">ë™ê¸°í™” ìƒíƒœ</div>
        <div class="sync-card-value" id="cardSyncStatus">-</div>
        <div class="sync-card-sub" id="cardSyncTime">-</div>
      </div>
      <div class="sync-card">
        <div class="sync-card-label">ë™ê¸°í™” íŒŒì¼</div>
        <div class="sync-card-value" id="cardSyncFiles">-</div>
        <div class="sync-card-sub" id="cardSyncFileSub">-</div>
      </div>
      <div class="sync-card">
        <div class="sync-card-label">ë²¡í„° DB ì²­í¬</div>
        <div class="sync-card-value" id="cardChunks">-</div>
        <div class="sync-card-sub" id="cardChunkSub">-</div>
      </div>
      <div class="sync-card">
        <div class="sync-card-label">ì—ëŸ¬</div>
        <div class="sync-card-value" id="cardErrors">-</div>
        <div class="sync-card-sub" id="cardErrorSub">-</div>
      </div>
    </div>

    <!-- íŒŒì¼ë³„ ìƒíƒœ + ì´ë²¤íŠ¸ ë¡œê·¸ -->
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 16px;">
      <!-- íŒŒì¼ë³„ ë™ê¸°í™” ìƒíƒœ -->
      <div>
        <div class="sync-section-title">
          <span>íŒŒì¼ë³„ ë™ê¸°í™” ìƒíƒœ</span>
          <div class="sync-actions">
            <button class="btn-sync" id="btnManualSync" onclick="manualSync()">
              <svg class="sync-icon" viewBox="0 0 24 24" fill="none"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              ìˆ˜ë™ ë™ê¸°í™”
            </button>
            <span class="sync-auto-refresh">30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ </span>
          </div>
        </div>
        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #334155; border-radius: 8px;">
          <table class="sync-file-table">
            <thead>
              <tr>
                <th>íŒŒì¼ëª…</th>
                <th>í¬ê¸°</th>
                <th>ìƒíƒœ</th>
                <th>ë§ˆì§€ë§‰ ë™ê¸°í™”</th>
              </tr>
            </thead>
            <tbody id="syncFileTableBody">
              <tr><td colspan="4" style="text-align:center; color:#475569; padding:20px;">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ìµœê·¼ ì´ë²¤íŠ¸ ë¡œê·¸ -->
      <div class="sync-events">
        <div class="sync-section-title">ìµœê·¼ ë™ê¸°í™” ì´ë²¤íŠ¸</div>
        <div class="sync-event-list" id="syncEventList">
          <div class="sync-event-item" style="justify-content:center; color:#475569; padding:20px;">ë¡œë”© ì¤‘...</div>
        </div>
      </div>
    </div>

    <!-- DB ê±´ê°• ìƒíƒœ -->
    <div class="db-health" id="dbHealthSection">
      <div class="db-health-header">
        <span class="db-health-title">
          ë²¡í„° DB ìƒíƒœ
        </span>
        <span class="db-health-overall" id="dbHealthOverall">í™•ì¸ ì¤‘...</span>
      </div>
      <div class="db-health-grid" id="dbHealthGrid">
        <div class="db-health-item">
          <span class="db-health-item-label">ChromaDB ì—°ê²°</span>
          <span class="db-health-item-value muted" id="dbHealthChroma">-</span>
        </div>
        <div class="db-health-item">
          <span class="db-health-item-label">ì»¬ë ‰ì…˜ ì¡´ì¬</span>
          <span class="db-health-item-value muted" id="dbHealthCollection">-</span>
        </div>
        <div class="db-health-item">
          <span class="db-health-item-label">ì„ë² ë”© ëª¨ë¸ (OpenAI)</span>
          <span class="db-health-item-value muted" id="dbHealthEmbedding">-</span>
        </div>
        <div class="db-health-item">
          <span class="db-health-item-label">ì €ì¥ ê²½ë¡œ</span>
          <span class="db-health-item-value muted" id="dbHealthDir">-</span>
        </div>
        <div class="db-health-item">
          <span class="db-health-item-label">ê²½ë¡œ ì“°ê¸° ê°€ëŠ¥</span>
          <span class="db-health-item-value muted" id="dbHealthWritable">-</span>
        </div>
        <div class="db-health-item">
          <span class="db-health-item-label">ì €ì¥ëœ ì²­í¬</span>
          <span class="db-health-item-value muted" id="dbHealthChunks">-</span>
        </div>
      </div>
      <div class="db-health-error" id="dbHealthError" style="display:none;">
        <span class="db-health-error-icon">âš ï¸</span>
        <span id="dbHealthErrorText"></span>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <!-- ì‚¬ì´ë“œë°” -->
  <aside class="sidebar">
    <div class="sidebar-header">Knowledge ë¬¸ì„œ</div>
    <div id="docList" class="doc-list">
      <div class="loading"><div class="spinner"></div> ë¬¸ì„œ ëª©ë¡ ë¡œë”© ì¤‘...</div>
    </div>
  </aside>

  <!-- ì—ë””í„° -->
  <main class="editor-area" id="editorArea">
    <div class="empty-state" id="emptyState">
      ì™¼ìª½ì—ì„œ ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”
    </div>

    <div id="editorPanel" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
      <div class="editor-toolbar">
        <span class="filename" id="currentFilename"></span>
        <button class="btn btn-tab active" id="tabEdit" onclick="switchTab('edit')">í¸ì§‘</button>
        <button class="btn btn-tab" id="tabPreview" onclick="switchTab('preview')">ë¯¸ë¦¬ë³´ê¸°</button>
        <button class="btn btn-tab" id="tabReview" onclick="switchTab('review')" style="display:none;">ë¦¬ë·°</button>
        <button class="btn btn-secondary" id="btnRevert" onclick="revertDocument()" disabled>ë˜ëŒë¦¬ê¸°</button>
        <button class="btn btn-primary" id="btnSave" onclick="saveDocument()" disabled>ì €ì¥</button>
      </div>
      <div class="editor-content">
        <textarea id="editor" spellcheck="false"></textarea>
        <div class="preview" id="preview"></div>
        <div class="review-view" id="reviewView"></div>
      </div>
    </div>
  </main>
</div>

<!-- ì±—ë´‡ í”Œë¡œíŒ… ë²„íŠ¼ -->
<button class="chat-fab" id="chatFab" onclick="toggleChat()">
  <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.2L4 17.2V4h16v12z"/></svg>
</button>

<!-- ì±—ë´‡ íŒ¨ë„ -->
<div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <div class="chat-header-left">
      <div class="chat-header-icon">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.2L4 17.2V4h16v12z"/></svg>
      </div>
      <div class="chat-header-info">
        <h3>ë¬¸ì„œ ë„ìš°ë¯¸</h3>
        <p>ë‚´ìš©ì´ ì–´ë””ì— ìˆëŠ”ì§€ ì°¾ì•„ë“œë ¤ìš”</p>
      </div>
    </div>
    <button class="chat-close" onclick="toggleChat()">
      <svg viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#94a3b8" stroke-width="2" stroke-linecap="round"/></svg>
    </button>
  </div>

  <div class="chat-messages" id="chatMessages">
    <div class="chat-msg bot">
      <div class="chat-bubble">ì•ˆë…•í•˜ì„¸ìš”! ì°¾ê³  ì‹¶ì€ ë‚´ìš©ì„ ë¬¼ì–´ë³´ì„¸ìš”. ì–´ëŠ ë¬¸ì„œì— ìˆëŠ”ì§€ ì•Œë ¤ë“œë¦¬ê³ , ë°”ë¡œ ì—´ì–´ë“œë¦´ê²Œìš” ğŸ“„</div>
    </div>
  </div>

  <div class="chat-input-area">
    <input type="text" id="chatInput" placeholder="ì˜ˆ: ë²™ ë§Œë“œëŠ” ë°©ë²•ì€ ì–´ë””ì— ìˆì–´?" onkeydown="if(event.key==='Enter')sendChat()" />
    <button class="chat-send" id="chatSend" onclick="sendChat()">
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const API = '';
  let currentFile = null;
  let originalContent = '';
  let hasChanges = false;

  // === ë¬¸ì„œ ëª©ë¡ ===

  async function loadDocuments() {
    try {
      const res = await fetch(`${API}/documents`);
      const data = await res.json();

      const list = document.getElementById('docList');
      list.innerHTML = '';

      const sorted = data.documents.sort((a, b) => a.filename.localeCompare(b.filename));
      sorted.forEach(doc => {
        const item = document.createElement('div');
        item.className = 'doc-item';
        item.dataset.filename = doc.filename;
        item.innerHTML = `
          <span>${doc.filename.replace(/^\d+_/, '').replace(/\.md$/, '').replace(/_/g, ' ')}</span>
          <span class="size">${formatSize(doc.size_bytes)}</span>
        `;
        item.onclick = () => openDocument(doc.filename);
        list.appendChild(item);
      });
    } catch (e) {
      document.getElementById('docList').innerHTML = '<div class="loading" style="color:#f87171">ë¬¸ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
    }
  }

  // === ë¬¸ì„œ ì—´ê¸° ===

  async function openDocument(filename) {
    if (hasChanges && !confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    // ì‚¬ì´ë“œë°” í™œì„± í‘œì‹œ
    document.querySelectorAll('.doc-item').forEach(el => el.classList.remove('active'));
    document.querySelector(`.doc-item[data-filename="${filename}"]`)?.classList.add('active');

    setStatus('ë¡œë”© ì¤‘...', '');

    try {
      const res = await fetch(`${API}/documents/${encodeURIComponent(filename)}`);
      if (!res.ok) throw new Error('ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      const data = await res.json();

      currentFile = filename;
      originalContent = data.content;

      document.getElementById('editor').value = data.content;
      document.getElementById('currentFilename').textContent = filename;
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('editorPanel').style.display = 'flex';

      hasChanges = false;
      updateButtons();
      switchTab('preview');
      setStatus('', '');
    } catch (e) {
      showToast(e.message, 'error');
      setStatus('ì˜¤ë¥˜', 'error');
    }
  }

  // === ë¬¸ì„œ ì €ì¥ ===

  async function saveDocument() {
    if (!currentFile) return;

    const content = document.getElementById('editor').value;
    setStatus('ì €ì¥ ì¤‘...', 'saving');

    try {
      const res = await fetch(`${API}/documents/${encodeURIComponent(currentFile)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content }),
      });

      if (!res.ok) throw new Error('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      const data = await res.json();

      originalContent = content;
      hasChanges = false;
      updateButtons();
      setStatus('ì €ì¥ë¨', 'saved');
      showToast(data.message, 'success');

      // ì‚¬ì´ë“œë°” ì‚¬ì´ì¦ˆ ì—…ë°ì´íŠ¸
      loadDocuments();
    } catch (e) {
      setStatus('ì €ì¥ ì‹¤íŒ¨', 'error');
      showToast(e.message, 'error');
    }
  }

  // === ë˜ëŒë¦¬ê¸° ===

  function revertDocument() {
    if (!confirm('ë³€ê²½ì‚¬í•­ì„ ëª¨ë‘ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    document.getElementById('editor').value = originalContent;
    hasChanges = false;
    updateButtons();
    setStatus('', '');
  }

  // === íƒ­ ì „í™˜ ===

  function switchTab(tab) {
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const reviewView = document.getElementById('reviewView');
    const tabEdit = document.getElementById('tabEdit');
    const tabPreview = document.getElementById('tabPreview');
    const tabReview = document.getElementById('tabReview');

    // ëª¨ë‘ ìˆ¨ê¸°ê¸°
    editor.classList.add('hidden');
    preview.classList.remove('visible');
    reviewView.classList.remove('visible');
    tabEdit.classList.remove('active');
    tabPreview.classList.remove('active');
    tabReview.classList.remove('active');

    if (tab === 'edit') {
      editor.classList.remove('hidden');
      tabEdit.classList.add('active');
    } else if (tab === 'preview') {
      preview.classList.add('visible');
      preview.innerHTML = renderMarkdown(editor.value);
      tabPreview.classList.add('active');
    } else if (tab === 'review') {
      reviewView.classList.add('visible');
      tabReview.classList.add('active');
    }
  }

  // === marked.js ì„¤ì • ===

  marked.setOptions({
    breaks: true,
    gfm: true,
    highlight: function(code, lang) {
      if (lang && hljs.getLanguage(lang)) {
        try { return hljs.highlight(code, { language: lang }).value; }
        catch (e) {}
      }
      try { return hljs.highlightAuto(code).value; }
      catch (e) {}
      return code;
    },
  });

  function renderMarkdown(md) {
    return marked.parse(md);
  }

  // === ìœ í‹¸ ===

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    return (bytes / 1024).toFixed(1) + ' KB';
  }

  function setStatus(text, type) {
    const el = document.getElementById('statusText');
    el.textContent = text;
    el.className = 'status' + (type ? ' ' + type : '');
  }

  function updateButtons() {
    document.getElementById('btnSave').disabled = !hasChanges;
    document.getElementById('btnRevert').disabled = !hasChanges;
  }

  function showToast(message, type) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} visible`;
    setTimeout(() => toast.classList.remove('visible'), 3000);
  }

  // === ì´ë²¤íŠ¸ ===

  document.getElementById('editor').addEventListener('input', () => {
    const current = document.getElementById('editor').value;
    hasChanges = current !== originalContent;
    updateButtons();
    if (hasChanges) setStatus('ìˆ˜ì •ë¨ (ë¯¸ì €ì¥)', '');
    else setStatus('', '');
  });

  // Ctrl+S / Cmd+S ë‹¨ì¶•í‚¤
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      if (hasChanges) saveDocument();
    }
  });

  // === ì±—ë´‡ ===

  let chatLoading = false;

  function toggleChat() {
    const panel = document.getElementById('chatPanel');
    const fab = document.getElementById('chatFab');
    const isOpen = panel.classList.toggle('open');
    fab.style.display = isOpen ? 'none' : 'flex';
    if (isOpen) {
      setTimeout(() => document.getElementById('chatInput').focus(), 100);
    }
  }

  function appendChatMessage(role, content) {
    const container = document.getElementById('chatMessages');
    const msg = document.createElement('div');
    msg.className = `chat-msg ${role}`;
    msg.innerHTML = `<div class="chat-bubble">${content}</div>`;
    container.appendChild(msg);
    container.scrollTop = container.scrollHeight;
    return msg;
  }

  function appendLoadingMessage() {
    const container = document.getElementById('chatMessages');
    const msg = document.createElement('div');
    msg.className = 'chat-msg bot';
    msg.id = 'chatLoading';
    msg.innerHTML = `<div class="chat-bubble"><div class="chat-dots"><span></span><span></span><span></span></div></div>`;
    container.appendChild(msg);
    container.scrollTop = container.scrollHeight;
  }

  function removeLoadingMessage() {
    const el = document.getElementById('chatLoading');
    if (el) el.remove();
  }

  function createLocationCards(locations) {
    return locations.map(loc => {
      const displayName = loc.filename.replace(/^\d+_/, '').replace(/\.md$/, '').replace(/_/g, ' ');
      return `<div class="loc-card" onclick="openDocFromChat('${loc.filename}')">
        <div class="loc-card-filename">ğŸ“„ ${displayName}</div>
        <div class="loc-card-section">${loc.section}</div>
        <div class="loc-card-snippet">"${loc.snippet}"</div>
        <div class="loc-card-open">í´ë¦­í•˜ì—¬ ë¬¸ì„œ ì—´ê¸° â†’</div>
      </div>`;
    }).join('');
  }

  function openDocFromChat(filename) {
    // ì±—ë´‡ ë‹«ê¸°
    toggleChat();
    // ë¬¸ì„œ ì—´ê¸°
    openDocument(filename);
  }

  // === ìˆ˜ì • ì˜ë„ íŒë³„ ===

  const EDIT_KEYWORDS = ['ìˆ˜ì •', 'ë°”ê¿”', 'ë°”ê¾¸', 'ë³€ê²½', 'ì¶”ê°€í•´', 'ì¶”ê°€í•˜', 'ì‚­ì œí•´', 'ì‚­ì œí•˜', 'ê³ ì³', 'ê³ ì¹˜', 'ì—…ë°ì´íŠ¸', 'í¸ì§‘', 'ë„£ì–´', 'ë¹¼ì¤˜', 'ë¹¼ì„œ', 'ì œê±°', 'êµì²´', 'ëŒ€ì²´', 'ì‘ì„±', 'ì¨ì¤˜', 'ì¨ì„œ', 'ì ì–´', 'ì§€ì›Œ', 'ì§€ìš°'];

  function isEditIntent(text) {
    return EDIT_KEYWORDS.some(kw => text.includes(kw));
  }

  // === Diff ìƒì„± (ì¤„ ë‹¨ìœ„ ë¹„êµ) ===

  function generateDiff(original, revised) {
    const origLines = original.split('\n');
    const revLines = revised.split('\n');

    // LCS (Longest Common Subsequence) ê¸°ë°˜ diff
    const m = origLines.length;
    const n = revLines.length;

    // DP í…Œì´ë¸” ìƒì„±
    const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        if (origLines[i - 1] === revLines[j - 1]) {
          dp[i][j] = dp[i - 1][j - 1] + 1;
        } else {
          dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
        }
      }
    }

    // ì—­ì¶”ì ìœ¼ë¡œ diff ìƒì„±
    const diff = [];
    let i = m, j = n;
    while (i > 0 || j > 0) {
      if (i > 0 && j > 0 && origLines[i - 1] === revLines[j - 1]) {
        diff.unshift({ type: 'unchanged', text: origLines[i - 1] });
        i--; j--;
      } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
        diff.unshift({ type: 'added', text: revLines[j - 1] });
        j--;
      } else {
        diff.unshift({ type: 'removed', text: origLines[i - 1] });
        i--;
      }
    }

    return diff;
  }

  function renderDiffHtml(diff, filename) {
    // ë³€ê²½ëœ ë¶€ë¶„ ì£¼ë³€ contextë§Œ ë³´ì—¬ì£¼ê¸° (ì „í›„ 2ì¤„)
    const CONTEXT = 2;
    const changeIndices = new Set();
    diff.forEach((line, idx) => {
      if (line.type !== 'unchanged') {
        for (let c = Math.max(0, idx - CONTEXT); c <= Math.min(diff.length - 1, idx + CONTEXT); c++) {
          changeIndices.add(c);
        }
      }
    });

    const displayName = filename.replace(/^\d+_/, '').replace(/\.md$/, '').replace(/_/g, ' ');
    let html = `<div class="diff-header">ğŸ“ ${displayName}</div>`;

    let lastShown = -1;
    diff.forEach((line, idx) => {
      if (!changeIndices.has(idx)) return;

      // ìƒëµ êµ¬ë¶„ì„ 
      if (lastShown !== -1 && idx - lastShown > 1) {
        html += `<div class="diff-line diff-line-separator">Â·Â·Â·</div>`;
      }
      lastShown = idx;

      const escaped = escapeHtml(line.text || ' ');
      if (line.type === 'removed') {
        html += `<div class="diff-line diff-line-removed">- ${escaped}</div>`;
      } else if (line.type === 'added') {
        html += `<div class="diff-line diff-line-added">+ ${escaped}</div>`;
      } else {
        html += `<div class="diff-line diff-line-unchanged">  ${escaped}</div>`;
      }
    });

    return html;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // === ìˆ˜ì • ì œì•ˆ í‘œì‹œ (ì±—ë´‡ ë²„ë¸” + ì—ë””í„° ë¦¬ë·° ëª¨ë“œ) ===

  let pendingEdit = null; // { filename, original, revised, hunks, hunkStates }

  /**
   * diff ë°°ì—´ì„ hunk(ë³€ê²½ ë¸”ë¡) ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤.
   * ê° hunkëŠ” ë³€ê²½ëœ ì¤„ + ì „í›„ context ì¤„ì„ í¬í•¨í•©ë‹ˆë‹¤.
   */
  function splitIntoHunks(diff, contextSize) {
    contextSize = contextSize || 3;
    // ë³€ê²½ëœ ì¤„ì˜ ì¸ë±ìŠ¤ ìˆ˜ì§‘
    const changeIndices = [];
    diff.forEach((line, idx) => {
      if (line.type !== 'unchanged') changeIndices.push(idx);
    });

    if (changeIndices.length === 0) return [];

    // ì¸ì ‘í•œ ë³€ê²½ì„ í•˜ë‚˜ì˜ hunkë¡œ ë¬¶ê¸°
    const hunks = [];
    let hunkStart = Math.max(0, changeIndices[0] - contextSize);
    let hunkEnd = Math.min(diff.length - 1, changeIndices[0] + contextSize);

    for (let ci = 1; ci < changeIndices.length; ci++) {
      const nextStart = Math.max(0, changeIndices[ci] - contextSize);
      const nextEnd = Math.min(diff.length - 1, changeIndices[ci] + contextSize);

      if (nextStart <= hunkEnd + 1) {
        // ì´ì „ hunkì™€ ê²¹ì¹˜ë©´ ë³‘í•©
        hunkEnd = nextEnd;
      } else {
        // ìƒˆ hunk ì‹œì‘
        hunks.push({ startIdx: hunkStart, endIdx: hunkEnd });
        hunkStart = nextStart;
        hunkEnd = nextEnd;
      }
    }
    hunks.push({ startIdx: hunkStart, endIdx: hunkEnd });

    // ê° hunkì— ì¤„ ë°ì´í„° í¬í•¨
    return hunks.map((h, i) => {
      const lines = diff.slice(h.startIdx, h.endIdx + 1);
      // ì›ë³¸ ê¸°ì¤€ ì¤„ë²ˆí˜¸ ê³„ì‚°
      let origLineNum = 0;
      for (let k = 0; k < h.startIdx; k++) {
        if (diff[k].type !== 'added') origLineNum++;
      }
      return {
        id: i,
        startIdx: h.startIdx,
        endIdx: h.endIdx,
        lines: lines,
        origStartLine: origLineNum + 1,
      };
    });
  }

  /**
   * ì—ë””í„° ë¦¬ë·° ëª¨ë“œì— hunkë³„ diffë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
   */
  function renderReviewMode(data) {
    const diff = generateDiff(data.original, data.revised);
    const hunks = splitIntoHunks(diff, 3);

    if (hunks.length === 0) return;

    pendingEdit = {
      filename: data.filename,
      original: data.original,
      revised: data.revised,
      diff: diff,
      hunks: hunks,
      hunkStates: hunks.map(() => 'pending'), // 'pending' | 'accepted' | 'rejected'
    };

    const reviewView = document.getElementById('reviewView');
    let html = '';

    // ìƒë‹¨ íˆ´ë°”
    const displayName = data.filename.replace(/^\d+_/, '').replace(/\.md$/, '').replace(/_/g, ' ');
    html += `<div class="review-toolbar">
      <div class="review-toolbar-info">
        <strong>${displayName}</strong> â€” ${hunks.length}ê°œ ë³€ê²½ ë¸”ë¡
      </div>
      <div class="review-toolbar-actions">
        <button class="btn btn-success" onclick="reviewAcceptAll()">ëª¨ë‘ ìˆ˜ë½</button>
        <button class="btn btn-danger" onclick="reviewRejectAll()">ëª¨ë‘ ê±°ë¶€</button>
        <button class="btn btn-primary" onclick="reviewApply()">ì €ì¥</button>
        <button class="btn btn-secondary" onclick="reviewExit()">ë‹«ê¸°</button>
      </div>
    </div>`;

    // ê° hunk ë Œë”ë§
    hunks.forEach((hunk, idx) => {
      html += `<div class="review-hunk" id="review-hunk-${idx}">`;
      html += `<div class="hunk-header">
        <span class="hunk-label">ë³€ê²½ ${idx + 1} (${hunk.origStartLine}ë²ˆ ì¤„ ë¶€ê·¼)</span>
        <div class="hunk-actions" id="hunk-actions-${idx}">
          <button class="hunk-btn hunk-btn-accept" onclick="reviewHunkAccept(${idx})">ìˆ˜ë½</button>
          <button class="hunk-btn hunk-btn-reject" onclick="reviewHunkReject(${idx})">ê±°ë¶€</button>
        </div>
      </div>`;

      html += `<div class="hunk-lines">`;
      let origNum = hunk.origStartLine;
      let revNum = hunk.origStartLine; // ëŒ€ëµì  ì¤„ë²ˆí˜¸
      // ì •í™•í•œ revNum ê³„ì‚°
      let addedBefore = 0, removedBefore = 0;
      for (let k = 0; k < hunk.startIdx; k++) {
        if (diff[k].type === 'added') addedBefore++;
        if (diff[k].type === 'removed') removedBefore++;
      }
      revNum = hunk.origStartLine + addedBefore - removedBefore;

      hunk.lines.forEach(line => {
        const escaped = escapeHtml(line.text || ' ');
        if (line.type === 'removed') {
          html += `<div class="hunk-line removed"><span class="hunk-line-num">${origNum}</span><span class="hunk-line-text">- ${escaped}</span></div>`;
          origNum++;
        } else if (line.type === 'added') {
          html += `<div class="hunk-line added"><span class="hunk-line-num">${revNum}</span><span class="hunk-line-text">+ ${escaped}</span></div>`;
          revNum++;
        } else {
          html += `<div class="hunk-line context"><span class="hunk-line-num">${origNum}</span><span class="hunk-line-text">  ${escaped}</span></div>`;
          origNum++;
          revNum++;
        }
      });

      html += `</div></div>`;
    });

    reviewView.innerHTML = html;
  }

  // === Hunk ìˆ˜ë½/ê±°ë¶€ ===

  function reviewHunkAccept(idx) {
    if (!pendingEdit) return;
    pendingEdit.hunkStates[idx] = 'accepted';
    updateHunkUI(idx);
  }

  function reviewHunkReject(idx) {
    if (!pendingEdit) return;
    pendingEdit.hunkStates[idx] = 'rejected';
    updateHunkUI(idx);
  }

  function reviewAcceptAll() {
    if (!pendingEdit) return;
    pendingEdit.hunkStates = pendingEdit.hunkStates.map(() => 'accepted');
    pendingEdit.hunkStates.forEach((_, idx) => updateHunkUI(idx));
  }

  function reviewRejectAll() {
    if (!pendingEdit) return;
    pendingEdit.hunkStates = pendingEdit.hunkStates.map(() => 'rejected');
    pendingEdit.hunkStates.forEach((_, idx) => updateHunkUI(idx));
  }

  function updateHunkUI(idx) {
    const hunkEl = document.getElementById(`review-hunk-${idx}`);
    const actionsEl = document.getElementById(`hunk-actions-${idx}`);
    if (!hunkEl || !actionsEl) return;

    const state = pendingEdit.hunkStates[idx];
    hunkEl.classList.remove('accepted', 'rejected');

    if (state === 'accepted') {
      hunkEl.classList.add('accepted');
      actionsEl.innerHTML = `<span class="hunk-status accepted">ìˆ˜ë½ë¨</span>
        <button class="hunk-btn hunk-btn-reject" onclick="reviewHunkReject(${idx})" style="font-size:10px;padding:2px 8px;">ë˜ëŒë¦¬ê¸°</button>`;
    } else if (state === 'rejected') {
      hunkEl.classList.add('rejected');
      actionsEl.innerHTML = `<span class="hunk-status rejected">ê±°ë¶€ë¨</span>
        <button class="hunk-btn hunk-btn-accept" onclick="reviewHunkAccept(${idx})" style="font-size:10px;padding:2px 8px;">ë˜ëŒë¦¬ê¸°</button>`;
    }
  }

  /**
   * ìˆ˜ë½ëœ hunkë§Œ ë°˜ì˜í•˜ì—¬ ìµœì¢… ë¬¸ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
   */
  function buildMergedContent() {
    if (!pendingEdit) return '';

    const diff = pendingEdit.diff;
    const hunks = pendingEdit.hunks;
    const states = pendingEdit.hunkStates;

    // ê° diff ì¤„ì´ ì–´ëŠ hunkì— ì†í•˜ëŠ”ì§€ ë§¤í•‘
    const lineHunkMap = {}; // diffIdx -> hunkIdx
    hunks.forEach((hunk, hIdx) => {
      for (let i = hunk.startIdx; i <= hunk.endIdx; i++) {
        if (diff[i].type !== 'unchanged') {
          lineHunkMap[i] = hIdx;
        }
      }
    });

    const result = [];
    diff.forEach((line, idx) => {
      const hunkIdx = lineHunkMap[idx];

      if (hunkIdx === undefined) {
        // hunkì— ì†í•˜ì§€ ì•ŠëŠ” ì¤„ (unchanged) -> ì›ë³¸ ìœ ì§€
        if (line.type !== 'added') {
          result.push(line.text);
        }
      } else {
        const state = states[hunkIdx];
        if (state === 'accepted') {
          // ìˆ˜ë½: added ì¤„ í¬í•¨, removed ì¤„ ì œì™¸
          if (line.type === 'added' || line.type === 'unchanged') {
            result.push(line.text);
          }
          // removedëŠ” ê±´ë„ˆëœ€
        } else {
          // ê±°ë¶€ ë˜ëŠ” pending: ì›ë³¸ ìœ ì§€
          if (line.type === 'removed' || line.type === 'unchanged') {
            result.push(line.text);
          }
          // addedëŠ” ê±´ë„ˆëœ€
        }
      }
    });

    return result.join('\n');
  }

  /**
   * ë¦¬ë·° ê²°ê³¼ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
   */
  async function reviewApply() {
    if (!pendingEdit) return;

    const accepted = pendingEdit.hunkStates.filter(s => s === 'accepted').length;
    const pending = pendingEdit.hunkStates.filter(s => s === 'pending').length;

    if (pending > 0) {
      if (!confirm(`ì•„ì§ ê²°ì •í•˜ì§€ ì•Šì€ ë³€ê²½ ë¸”ë¡ì´ ${pending}ê°œ ìˆìŠµë‹ˆë‹¤. ë¯¸ê²°ì • ë¸”ë¡ì€ ê±°ë¶€ ì²˜ë¦¬ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    }

    if (accepted === 0) {
      showToast('ìˆ˜ë½ëœ ë³€ê²½ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
      return;
    }

    const mergedContent = buildMergedContent();

    try {
      const res = await fetch(`${API}/documents/${encodeURIComponent(pendingEdit.filename)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: mergedContent }),
      });

      if (!res.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');

      // ì—ë””í„° ê°±ì‹ 
      document.getElementById('editor').value = mergedContent;
      originalContent = mergedContent;
      hasChanges = false;
      updateButtons();

      const total = pendingEdit.hunkStates.length;
      showToast(`${accepted}/${total}ê°œ ë³€ê²½ ë¸”ë¡ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');

      // ì‚¬ì´ë“œë°” ê°±ì‹ 
      loadDocuments();

      // ì±—ë´‡ì— ê²°ê³¼ ì•Œë¦¼
      notifyReviewResult(accepted, total);

      // ë¦¬ë·° ëª¨ë“œ ì¢…ë£Œ
      reviewExit();

    } catch (e) {
      showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  function reviewExit() {
    // ë¦¬ë·° íƒ­ ìˆ¨ê¸°ê¸°
    document.getElementById('tabReview').style.display = 'none';
    pendingEdit = null;
    switchTab('preview');
  }

  /**
   * ì±—ë´‡ì— ë¦¬ë·° ê²°ê³¼ë¥¼ ì•Œë¦½ë‹ˆë‹¤.
   */
  function notifyReviewResult(accepted, total) {
    const container = document.getElementById('chatMessages');
    // ê¸°ì¡´ ë¦¬ë·° ì•ˆë‚´ ë²„ë¸”ì˜ ì•¡ì…˜ ì˜ì—­ ì—…ë°ì´íŠ¸
    const reviewActions = document.getElementById('chat-review-actions');
    if (reviewActions) {
      reviewActions.innerHTML = `<span style="color:#4ade80; font-size:12px; font-weight:600;">âœ“ ${accepted}/${total}ê°œ ë³€ê²½ì´ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤</span>`;
    }
  }

  // === ì±—ë´‡ì—ì„œ ìˆ˜ì • ì œì•ˆ ì‹œ ì—ë””í„° ë¦¬ë·° ëª¨ë“œ ì§„ì… ===

  function showEditProposal(data) {
    const container = document.getElementById('chatMessages');
    const msg = document.createElement('div');
    msg.className = 'chat-msg bot';

    const diff = generateDiff(data.original, data.revised);
    const diffHasChanges = diff.some(d => d.type !== 'unchanged');

    if (!diffHasChanges || !data.revised) {
      msg.innerHTML = `<div class="chat-bubble">${renderMarkdown(data.summary || 'ìš”ì²­í•˜ì‹  ë‚´ìš©ì— í•´ë‹¹í•˜ëŠ” ë³€ê²½ì‚¬í•­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')}</div>`;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
      return;
    }

    // ì±—ë´‡ ë²„ë¸”: ìš”ì•½ + ê°„ë‹¨í•œ diff + ë¬¸ì„œì—ì„œ ë¦¬ë·°í•˜ê¸° ë²„íŠ¼
    const hunks = splitIntoHunks(diff, 2);
    const displayName = data.filename.replace(/^\d+_/, '').replace(/\.md$/, '').replace(/_/g, ' ');
    const diffHtml = renderDiffHtml(diff, data.filename);

    msg.innerHTML = `<div class="chat-bubble">
      <div class="edit-summary">${renderMarkdown(data.summary)}</div>
      <div class="diff-container">${diffHtml}</div>
      <div class="diff-actions" id="chat-review-actions">
        <button class="diff-btn-apply" onclick="openReviewMode()">ë¬¸ì„œì—ì„œ ë¦¬ë·°í•˜ê¸°</button>
        <button class="diff-btn-cancel" onclick="cancelReviewFromChat()">ì·¨ì†Œ</button>
      </div>
    </div>`;

    container.appendChild(msg);
    container.scrollTop = container.scrollHeight;

    // ë¦¬ë·° ë°ì´í„°ë¥¼ ì„ì‹œ ì €ì¥ (ì—ë””í„° ë¦¬ë·° ëª¨ë“œ ì§„ì…ìš©)
    window._pendingReviewData = data;
  }

  function openReviewMode() {
    const data = window._pendingReviewData;
    if (!data) return;

    // í•´ë‹¹ ë¬¸ì„œ ì—´ê¸° (ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ê±´ë„ˆëœ€)
    if (currentFile !== data.filename) {
      // ë¬¸ì„œë¥¼ ì§ì ‘ ë¡œë“œ
      currentFile = data.filename;
      originalContent = data.original;
      document.getElementById('editor').value = data.original;
      document.getElementById('currentFilename').textContent = data.filename;
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('editorPanel').style.display = 'flex';
      hasChanges = false;
      updateButtons();

      // ì‚¬ì´ë“œë°” í™œì„± í‘œì‹œ
      document.querySelectorAll('.doc-item').forEach(el => el.classList.remove('active'));
      document.querySelector(`.doc-item[data-filename="${data.filename}"]`)?.classList.add('active');
    }

    // ë¦¬ë·° ëª¨ë“œ ë Œë”ë§
    renderReviewMode(data);

    // ë¦¬ë·° íƒ­ í‘œì‹œ ë° ì „í™˜
    document.getElementById('tabReview').style.display = '';
    switchTab('review');

    // ì±—ë´‡ ë‹«ê¸°
    const panel = document.getElementById('chatPanel');
    if (panel.classList.contains('open')) {
      toggleChat();
    }

    window._pendingReviewData = null;
  }

  function cancelReviewFromChat() {
    const actionsEl = document.getElementById('chat-review-actions');
    if (actionsEl) {
      actionsEl.innerHTML = `<span style="color:#94a3b8; font-size:12px;">ìˆ˜ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤</span>`;
    }
    window._pendingReviewData = null;
  }

  // === ì±—ë´‡ ë©”ì‹œì§€ ì „ì†¡ (ìˆ˜ì • ì˜ë„ ë¶„ê¸°) ===

  async function sendChat() {
    const input = document.getElementById('chatInput');
    const question = input.value.trim();
    if (!question || chatLoading) return;

    // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
    appendChatMessage('user', question);
    input.value = '';
    chatLoading = true;
    input.disabled = true;
    document.getElementById('chatSend').disabled = true;

    // ë¡œë”© í‘œì‹œ
    appendLoadingMessage();

    try {
      if (isEditIntent(question)) {
        // === ìˆ˜ì • ìš”ì²­ ===
        const res = await fetch(`${API}/rag/edit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question }),
        });

        if (!res.ok) throw new Error('ì‘ë‹µ ì˜¤ë¥˜');
        const data = await res.json();

        removeLoadingMessage();
        showEditProposal(data);

      } else {
        // === ì¼ë°˜ ì§ˆë¬¸ (ìœ„ì¹˜ ì°¾ê¸°) ===
        const res = await fetch(`${API}/rag/locate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question }),
        });

        if (!res.ok) throw new Error('ì‘ë‹µ ì˜¤ë¥˜');
        const data = await res.json();

        removeLoadingMessage();

        let botContent = renderMarkdown(data.answer);
        if (data.locations && data.locations.length > 0) {
          botContent += createLocationCards(data.locations);
        }

        const container = document.getElementById('chatMessages');
        const msg = document.createElement('div');
        msg.className = 'chat-msg bot';
        msg.innerHTML = `<div class="chat-bubble">${botContent}</div>`;
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;
      }

    } catch (e) {
      removeLoadingMessage();
      appendChatMessage('bot', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      chatLoading = false;
      input.disabled = false;
      document.getElementById('chatSend').disabled = false;
      input.focus();
    }
  }

  // === ë™ê¸°í™” ìƒíƒœ ëŒ€ì‹œë³´ë“œ ===

  let syncDashboardOpen = false;
  let syncRefreshTimer = null;

  function toggleSyncDashboard() {
    const dashboard = document.getElementById('syncDashboard');
    const toggle = document.getElementById('syncToggle');
    syncDashboardOpen = !syncDashboardOpen;

    if (syncDashboardOpen) {
      dashboard.classList.add('open');
      toggle.classList.add('expanded');
      loadSyncStatus();
      // 30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
      syncRefreshTimer = setInterval(loadSyncStatus, 30000);
    } else {
      dashboard.classList.remove('open');
      toggle.classList.remove('expanded');
      if (syncRefreshTimer) {
        clearInterval(syncRefreshTimer);
        syncRefreshTimer = null;
      }
    }
  }

  function formatTimeAgo(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);

    if (diffSec < 60) return `${diffSec}ì´ˆ ì „`;
    if (diffMin < 60) return `${diffMin}ë¶„ ì „`;
    if (diffHour < 24) return `${diffHour}ì‹œê°„ ì „`;
    return `${diffDay}ì¼ ì „`;
  }

  function formatLocalTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  function getEventTypeLabel(type) {
    const labels = {
      'full_sync': 'ì „ì²´ ë™ê¸°í™”',
      'file_added': 'íŒŒì¼ ì¶”ê°€',
      'file_modified': 'íŒŒì¼ ìˆ˜ì •',
      'file_deleted': 'íŒŒì¼ ì‚­ì œ',
      'file_sync_error': 'ë™ê¸°í™” ì˜¤ë¥˜',
      'file_delete_error': 'ì‚­ì œ ì˜¤ë¥˜',
    };
    return labels[type] || type;
  }

  async function loadSyncStatus() {
    try {
      const res = await fetch(`${API}/documents/status`);
      if (!res.ok) throw new Error('ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨');
      const data = await res.json();
      renderSyncDashboard(data);
      updateSyncIndicator(data);
    } catch (e) {
      updateSyncIndicator({ is_ready: false, last_sync_result: 'error' });
    }
  }

  function updateSyncIndicator(data) {
    const indicator = document.getElementById('syncIndicator');
    const label = document.getElementById('syncToggleLabel');

    indicator.className = 'indicator';

    // DB ê±´ê°• ìƒíƒœê°€ ì‹¬ê°í•˜ë©´ ìµœìš°ì„  í‘œì‹œ
    if (data.db_health && (!data.db_health.chroma_connected || !data.db_health.embedding_model_ok)) {
      indicator.classList.add('error');
      label.textContent = 'DB ì´ìƒ ê°ì§€';
      return;
    }

    // DBê°€ ë¹„ì–´ìˆìœ¼ë©´ ê²½ê³ 
    if (data.is_ready && data.db_chunk_count === 0) {
      indicator.classList.add('error');
      label.textContent = 'DB ë¹„ì–´ìˆìŒ';
      return;
    }

    if (!data.is_ready) {
      indicator.classList.add('syncing');
      label.textContent = 'ë™ê¸°í™” ì¤‘...';
    } else if (data.last_sync_result === 'success') {
      // ì²­í¬ ë¶ˆì¼ì¹˜ ì²´í¬
      if (data.total_chunks > 0 && data.db_chunk_count >= 0 && data.total_chunks !== data.db_chunk_count) {
        indicator.classList.add('error');
        label.textContent = 'ì²­í¬ ë¶ˆì¼ì¹˜';
      } else {
        indicator.classList.add('ready');
        label.textContent = 'ë™ê¸°í™” ì •ìƒ';
      }
    } else if (data.last_sync_result === 'partial') {
      indicator.classList.add('error');
      label.textContent = 'ì¼ë¶€ ì˜¤ë¥˜';
    } else if (data.last_sync_result === 'failed' || data.last_sync_result === 'error') {
      indicator.classList.add('error');
      label.textContent = 'ë™ê¸°í™” ì‹¤íŒ¨';
    } else {
      indicator.classList.add('unknown');
      label.textContent = 'ë™ê¸°í™” ìƒíƒœ';
    }
  }

  function renderSyncDashboard(data) {
    // ìƒíƒœ ì¹´ë“œ - ë™ê¸°í™” ìƒíƒœ
    const cardStatus = document.getElementById('cardSyncStatus');
    const cardTime = document.getElementById('cardSyncTime');

    if (!data.is_ready) {
      cardStatus.textContent = 'ë™ê¸°í™” ì¤‘';
      cardStatus.className = 'sync-card-value warning';
    } else if (data.last_sync_result === 'success') {
      cardStatus.textContent = 'ì •ìƒ';
      cardStatus.className = 'sync-card-value success';
    } else if (data.last_sync_result === 'partial') {
      cardStatus.textContent = 'ì¼ë¶€ ì˜¤ë¥˜';
      cardStatus.className = 'sync-card-value warning';
    } else if (data.last_sync_result === 'failed') {
      cardStatus.textContent = 'ì‹¤íŒ¨';
      cardStatus.className = 'sync-card-value error';
    } else {
      cardStatus.textContent = 'ëŒ€ê¸°';
      cardStatus.className = 'sync-card-value muted';
    }
    cardTime.textContent = data.last_sync_at ? formatTimeAgo(data.last_sync_at) : 'ì•„ì§ ë™ê¸°í™”ë˜ì§€ ì•ŠìŒ';

    // ìƒíƒœ ì¹´ë“œ - íŒŒì¼ ìˆ˜
    const cardFiles = document.getElementById('cardSyncFiles');
    const cardFileSub = document.getElementById('cardSyncFileSub');
    cardFiles.textContent = data.synced_files;
    cardFiles.className = 'sync-card-value' + (data.synced_files > 0 ? '' : ' muted');
    const totalFiles = data.file_statuses ? data.file_statuses.length : 0;
    cardFileSub.textContent = `ì „ì²´ ${totalFiles}ê°œ ì¤‘`;

    // ìƒíƒœ ì¹´ë“œ - ì²­í¬
    const cardChunks = document.getElementById('cardChunks');
    const cardChunkSub = document.getElementById('cardChunkSub');
    cardChunks.textContent = data.db_chunk_count >= 0 ? data.db_chunk_count : '?';
    cardChunks.className = 'sync-card-value' + (data.db_chunk_count > 0 ? '' : ' warning');
    cardChunkSub.textContent = data.total_chunks > 0 ? `ì˜ˆìƒ: ${data.total_chunks}ê°œ` : '-';

    // ìƒíƒœ ì¹´ë“œ - ì—ëŸ¬
    const cardErrors = document.getElementById('cardErrors');
    const cardErrorSub = document.getElementById('cardErrorSub');
    const errorCount = data.errors ? data.errors.length : 0;
    cardErrors.textContent = errorCount;
    cardErrors.className = 'sync-card-value' + (errorCount > 0 ? ' error' : ' success');
    cardErrorSub.textContent = errorCount > 0 ? data.errors.join(', ') : 'ì˜¤ë¥˜ ì—†ìŒ';

    // íŒŒì¼ë³„ ìƒíƒœ í…Œì´ë¸”
    const tbody = document.getElementById('syncFileTableBody');
    if (data.file_statuses && data.file_statuses.length > 0) {
      tbody.innerHTML = data.file_statuses.map(f => {
        const displayName = f.filename.replace(/^\d+_/, '').replace(/\.md$/, '').replace(/_/g, ' ');
        let badge;
        if (f.has_error) {
          badge = '<span class="sync-badge err">ì˜¤ë¥˜</span>';
        } else if (f.synced_at) {
          badge = '<span class="sync-badge ok">ì •ìƒ</span>';
        } else {
          badge = '<span class="sync-badge pending">ë¯¸ë™ê¸°í™”</span>';
        }
        return `<tr>
          <td title="${f.filename}">${displayName}</td>
          <td>${formatSize(f.size_bytes)}</td>
          <td>${badge}</td>
          <td style="font-size:12px; color:#64748b;">${f.synced_at ? formatTimeAgo(f.synced_at) : '-'}</td>
        </tr>`;
      }).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#475569; padding:20px;">ë¬¸ì„œ ì—†ìŒ</td></tr>';
    }

    // ì´ë²¤íŠ¸ ë¡œê·¸
    const eventList = document.getElementById('syncEventList');
    if (data.recent_events && data.recent_events.length > 0) {
      // ìµœì‹  ì´ë²¤íŠ¸ê°€ ìœ„ë¡œ
      const reversed = [...data.recent_events].reverse();
      eventList.innerHTML = reversed.map(e => {
        const iconClass = e.success ? 'ok' : 'err';
        const displayName = e.filename.replace(/^\d+_/, '').replace(/\.md$/, '').replace(/_/g, ' ');
        const detail = e.detail ? ` â€” ${e.detail}` : '';
        return `<div class="sync-event-item">
          <span class="sync-event-time">${formatLocalTime(e.timestamp)}</span>
          <span class="sync-event-icon ${iconClass}"></span>
          <span class="sync-event-text">
            <span class="sync-event-file">${displayName}</span>
            ${getEventTypeLabel(e.type)}${detail}
          </span>
        </div>`;
      }).join('');
    } else {
      eventList.innerHTML = '<div class="sync-event-item" style="justify-content:center; color:#475569; padding:20px;">ì´ë²¤íŠ¸ ì—†ìŒ</div>';
    }

    // ê²½ê³  ë°°ë„ˆ
    renderWarningBanner(data);

    // DB ê±´ê°• ìƒíƒœ
    if (data.db_health) {
      renderDbHealth(data.db_health, data);
    }
  }

  function renderWarningBanner(data) {
    const banner = document.getElementById('syncWarningBanner');
    const text = document.getElementById('syncWarningText');
    const warnings = [];

    // ì²­í¬ ìˆ˜ ë¶ˆì¼ì¹˜ ê²½ê³ 
    if (data.total_chunks > 0 && data.db_chunk_count >= 0 && data.total_chunks !== data.db_chunk_count) {
      warnings.push(`ë²¡í„° DB ì²­í¬ ìˆ˜ ë¶ˆì¼ì¹˜: ì˜ˆìƒ ${data.total_chunks}ê°œ â†’ ì‹¤ì œ ${data.db_chunk_count}ê°œ. ìˆ˜ë™ ë™ê¸°í™”ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.`);
    }

    // DBê°€ ë¹„ì–´ìˆëŠ” ê²½ê³ 
    if (data.is_ready && data.db_chunk_count === 0) {
      warnings.push('ë²¡í„° DBê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì±—ë´‡ì´ ì§ˆë¬¸ì— ë‹µë³€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ ë™ê¸°í™”ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
    }

    // ë™ê¸°í™” ì¤€ë¹„ ì•ˆë¨
    if (!data.is_ready && data.last_sync_at) {
      warnings.push('ë¬¸ì„œ ë™ê¸°í™”ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì™„ë£Œë  ë•Œê¹Œì§€ ì±—ë´‡ ì‘ë‹µì´ ì œí•œë©ë‹ˆë‹¤.');
    }

    // DB ê±´ê°• ë¬¸ì œ
    if (data.db_health) {
      if (!data.db_health.chroma_connected) {
        warnings.push('ChromaDBì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
      if (data.db_health.chroma_connected && !data.db_health.collection_exists && data.is_ready) {
        warnings.push('ë²¡í„° DB ì»¬ë ‰ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìˆ˜ë™ ë™ê¸°í™”ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
      }
      if (!data.db_health.embedding_model_ok) {
        warnings.push(`ì„ë² ë”© ëª¨ë¸ ì˜¤ë¥˜: ${data.db_health.embedding_error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}. ìƒˆ ë¬¸ì„œ ë™ê¸°í™”ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`);
      }
      if (!data.db_health.chroma_dir_writable) {
        warnings.push('ChromaDB ì €ì¥ ê²½ë¡œì— ì“°ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
      }
    }

    if (warnings.length > 0) {
      text.textContent = warnings.join(' | ');
      banner.classList.add('visible');
    } else {
      banner.classList.remove('visible');
    }
  }

  function renderDbHealth(health, data) {
    const overall = document.getElementById('dbHealthOverall');

    // ì¢…í•© íŒì •
    const allOk = health.chroma_connected && health.collection_exists && health.embedding_model_ok && health.chunk_count > 0;
    const critical = !health.chroma_connected || !health.embedding_model_ok;

    if (allOk) {
      overall.textContent = 'ì •ìƒ';
      overall.className = 'db-health-overall healthy';
    } else if (critical) {
      overall.textContent = 'ë¹„ì •ìƒ';
      overall.className = 'db-health-overall unhealthy';
    } else {
      overall.textContent = 'ì£¼ì˜';
      overall.className = 'db-health-overall degraded';
    }

    // ê°œë³„ í•­ëª©
    setHealthItem('dbHealthChroma', health.chroma_connected, 'ì—°ê²°ë¨', 'ì—°ê²° ì‹¤íŒ¨');
    setHealthItem('dbHealthCollection', health.collection_exists, 'ì¡´ì¬', 'ì—†ìŒ');
    setHealthItem('dbHealthEmbedding', health.embedding_model_ok, 'ì •ìƒ', health.embedding_error ? 'ì˜¤ë¥˜' : 'ë¯¸í™•ì¸');

    const dirEl = document.getElementById('dbHealthDir');
    dirEl.textContent = health.chroma_dir || '-';
    dirEl.className = 'db-health-item-value' + (health.chroma_dir_exists ? ' ok' : ' fail');

    setHealthItem('dbHealthWritable', health.chroma_dir_writable, 'ê°€ëŠ¥', 'ë¶ˆê°€');

    const chunksEl = document.getElementById('dbHealthChunks');
    chunksEl.textContent = health.chunk_count >= 0 ? `${health.chunk_count}ê°œ` : 'ì¡°íšŒ ì‹¤íŒ¨';
    chunksEl.className = 'db-health-item-value' + (health.chunk_count > 0 ? ' ok' : health.chunk_count === 0 ? ' warn' : ' fail');

    // ì—ëŸ¬ ë©”ì‹œì§€
    const errorSection = document.getElementById('dbHealthError');
    const errorText = document.getElementById('dbHealthErrorText');
    const errors = [];
    if (health.chroma_error) errors.push(`ChromaDB: ${health.chroma_error}`);
    if (health.embedding_error) errors.push(`ì„ë² ë”©: ${health.embedding_error}`);

    if (errors.length > 0) {
      errorText.textContent = errors.join(' | ');
      errorSection.style.display = 'flex';
    } else {
      errorSection.style.display = 'none';
    }
  }

  function setHealthItem(id, isOk, okText, failText) {
    const el = document.getElementById(id);
    if (isOk) {
      el.textContent = `âœ“ ${okText}`;
      el.className = 'db-health-item-value ok';
    } else {
      el.textContent = `âœ— ${failText}`;
      el.className = 'db-health-item-value fail';
    }
  }

  async function manualSync() {
    const btn = document.getElementById('btnManualSync');
    btn.disabled = true;
    btn.classList.add('syncing');
    btn.querySelector('.sync-icon')?.setAttribute('style', '');

    try {
      const res = await fetch(`${API}/documents/sync`, { method: 'POST' });
      if (!res.ok) throw new Error('ë™ê¸°í™” ì‹¤íŒ¨');
      const data = await res.json();
      showToast(data.message, 'success');
      // ìƒíƒœ ê°±ì‹ 
      await loadSyncStatus();
      // ë¬¸ì„œ ëª©ë¡ë„ ê°±ì‹ 
      loadDocuments();
    } catch (e) {
      showToast('ìˆ˜ë™ ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
      btn.disabled = false;
      btn.classList.remove('syncing');
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë™ê¸°í™” ìƒíƒœ ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
  async function initSyncIndicator() {
    try {
      const res = await fetch(`${API}/documents/status`);
      if (res.ok) {
        const data = await res.json();
        updateSyncIndicator(data);
      }
    } catch (e) {
      // ë¬´ì‹œ
    }
  }

  // ì´ˆê¸° ë¡œë“œ
  loadDocuments();
  initSyncIndicator();
</script>

</body>
</html>
